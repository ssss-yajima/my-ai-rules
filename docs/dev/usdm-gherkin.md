# USDM(YAML)とGherkinを用いた設計手法

## 概要

USDM（Universal Specification Describing Manner）とGherkinを組み合わせてシステムの要件定義およびBDDによるシステム設計を行います。
YAML形式のUSDM定義とGherkinシナリオを連携させることで、要件からテストまでのトレーサビリティを確保します。

USDMではシステム設計や非機能要件は表現できないため、それらはDesignDocに記載します。
必要に応じてファイルを追加で作成します。

## USDM(YAML)とGherkinを用いた開発ワークフロー

### USDMによる要求・仕様の定義


1. **要求（Requirement）の定義**
   - プロジェクトの目的・概要を記述
   - 各機能要求をREQ-XXX形式で記述
   - 要求の優先度を設定

2. **仕様（Specification）の定義**
   - 各要求に対する詳細仕様をSPEC-XXX-YY形式で記述
   - 仕様の根拠（rationale）を明記
   - 関連する仕様がある場合は関連IDを記述

3. **形式的レビュー**
   - JSONスキーマによるバリデーション実施
   - ID、フォーマットの正確性確認

4. **内容的レビュー**
   - 要求・仕様の明確性、検証可能性の確認
   - 矛盾、欠落の有無確認
   - ステークホルダーによる承認

### BDD/ATDD - Gherkinシナリオの作成

1. **各仕様に対応するシナリオの定義**
   - シナリオ名はUSDMの仕様名と一致させる
   - @USDMタグによる関連付け
   - Given-When-Then形式での具体的な振る舞いの記述

2. **エッジケースの考慮**
   - 正常系だけでなく異常系のシナリオも作成
   - バリエーションが多い場合はScenario Outlineの活用

### トレーサビリティの確認

1. **双方向の参照整合性確認**
   - すべての仕様に対応するシナリオが存在するか確認
   - すべてのシナリオが対応する仕様を持つか確認

2. **トレーサビリティレポートの作成**
   - 必要に応じてトレーサビリティマトリックスを生成
   - カバレッジ分析の実施


## USDM(YAML)とGherkin 記述ルール

### 1. USDM(YAML)記述ルール

#### 1.1 基本構造

USDMのYAML記述は以下の階層構造に従います：

```yaml
$schema: "./usdm-schema.json"  # スキーマ参照（省略可）
title: "プロジェクト要件定義書"   # 文書タイトル（必須）
purpose: |                     # 目的（必須）
  システムの目的を記述します。
  複数行の記述が可能です。
overview: |                    # 概要（必須）
  システムの概要を記述します。
  複数行の記述が可能です。
requirements:                  # 要求一覧（必須）
  - id: REQ-001               # 要求ID（必須）
    type: 要求                 # タイプ（必須）
    name: 要求名               # 要求名（必須）
    description: 要求の説明     # 要求説明（必須）
    notes: 備考（任意）         # 備考（任意）
    specifications:           # 仕様一覧（必須）
      - id: SPEC-001-01       # 仕様ID（必須）
        type: 仕様             # タイプ（必須）
        name: 仕様名           # 仕様名（必須）
        description: 仕様の説明 # 仕様説明（必須）
        rationale: 根拠        # 根拠（必須）
        related_id: REQ-002   # 関連ID（任意）
        gherkin_scenario: シナリオ名 # 関連Gherkinシナリオ（任意）
```

#### 1.2 命名規則

##### ID命名規則

- **要求ID**: `REQ-XXX`
  - XXXは3桁の連番（001から開始）
  - 例: `REQ-001`, `REQ-002`

- **仕様ID**: `SPEC-XXX-YY`
  - XXXは対応する要求番号
  - YYは2桁の連番（01から開始）
  - 例: `SPEC-001-01`, `SPEC-001-02`

##### 説明文の記述ルール

- **要求説明**:
  - 「〜できる」「〜する」という形式で記述
  - 機能の主体（誰が）を明確に
  - 機能の目的を含める

- **仕様説明**:
  - 具体的な振る舞いや条件を記述
  - 検証可能な形で記述
  - 曖昧さを排除

#### 1.3 トレーサビリティ管理

- **関連ID（related_id）**:
  - 関連する他の要求・仕様IDを記載
  - 複数ある場合は配列形式で記載
  - 例: `related_id: [SPEC-001-01, SPEC-002-03]`

- **Gherkinシナリオ（gherkin_scenario）**:
  - 対応するGherkinシナリオ名を正確に記載
  - シナリオ名は完全一致で記載

### 2. Gherkin記述ルール

#### 2.1 基本構造

```gherkin
# language: ja  # 言語指定（任意）

@USDM:REQ-001  # USDMとの関連付けタグ
Feature: 機能名
  機能の説明を記述します。
  複数行記述できます。

  @USDM:SPEC-001-01  # USDMとの関連付けタグ
  Scenario: シナリオ名
    Given 前提条件
    When アクション
    Then 期待結果
    And 追加条件
```

#### 2.2 命名規則と記述ルール

##### Feature（機能）

- USDMの要求（REQ）に対応
- 明確で簡潔な名前をつける
- 詳細な説明を記述する
- 対応するUSDM要求IDをタグ付け

##### Scenario（シナリオ）

- USDMの仕様（SPEC）に対応
- シナリオ名はUSDMの仕様名と一致させる
- 対応するUSDM仕様IDをタグ付け

##### ステップ記述

- **Given**（前提条件）:
  - システムの初期状態を記述
  - 「〜が存在する」「〜の状態である」という形式

- **When**（アクション）:
  - ユーザーの操作や入力を記述
  - 「〜をクリックする」「〜を入力する」という形式

- **Then**（期待結果）:
  - システムの応答や状態変化を記述
  - 検証可能な形で記述

- **And/But**（追加条件）:
  - 前のステップと同じタイプの追加条件を記述

#### 2.3 タグ付けルール

- **要求タグ**: `@USDM:REQ-XXX`
  - Featureブロックの直前に配置
  - 対応するUSDM要求IDを指定

- **仕様タグ**: `@USDM:SPEC-XXX-YY`
  - Scenarioブロックの直前に配置
  - 対応するUSDM仕様IDを指定

- **その他のタグ**: 
  - `@重要`, `@UI`, `@API`などのカテゴリタグも使用可能
  - テスト実行の制御にも利用可能

### 3. バリデーションルール

#### 3.1 USDM(YAML)バリデーション

- すべての必須フィールドが存在すること
- IDが正しい形式であること
- 関連IDが実際に存在するIDを参照していること
- Gherkinシナリオ名が実際に存在するシナリオを参照していること

#### 3.2 Gherkinバリデーション

- すべてのシナリオにUSDMタグが付与されていること
- USDMタグが実際に存在するIDを参照していること
- 各ステップが適切な形式で記述されていること

#### 3.3 トレーサビリティバリデーション

- すべてのUSDM仕様に対応するGherkinシナリオが存在すること
- すべてのGherkinシナリオが対応するUSDM仕様を持つこと
- 双方向の参照が一致していること

### 4. ベストプラクティス

#### 4.1 USDM記述のベストプラクティス

- 要求は機能単位で分割する
- 仕様は検証可能な粒度で記述する
- 根拠（rationale）には要求との関連性を明記する
- 関連IDは積極的に活用し、依存関係を明確にする

#### 4.2 Gherkin記述のベストプラクティス

- シナリオは1つの機能の1つの側面のみをテストする
- ステップは具体的な値を使用する
- UIの細かい実装詳細ではなく、ユーザーの意図を記述する
- 複数シナリオで共通の前提条件はBackgroundとして記述する
